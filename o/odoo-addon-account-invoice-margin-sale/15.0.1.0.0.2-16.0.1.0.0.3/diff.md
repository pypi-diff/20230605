# Comparing `tmp/odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2-py3-none-any.whl.zip` & `tmp/odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,21 +1,22 @@
-Zip file size: 24647 bytes, number of entries: 19
--rw-r--r--  2.0 unx     3432 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/README.rst
--rw-r--r--  2.0 unx       86 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/__init__.py
--rw-r--r--  2.0 unx      699 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/__manifest__.py
--rw-r--r--  2.0 unx      810 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/i18n/account_invoice_margin_sale.pot
--rw-r--r--  2.0 unx     1034 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/i18n/es.po
--rw-r--r--  2.0 unx      114 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/models/__init__.py
--rw-r--r--  2.0 unx      883 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/models/account_invoice.py
--rw-r--r--  2.0 unx      444 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/models/sale.py
--rw-r--r--  2.0 unx      196 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/readme/CONTRIBUTORS.rst
--rw-r--r--  2.0 unx       76 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/readme/DESCRIPTION.rst
--rw-r--r--  2.0 unx       31 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/readme/INSTALL.rst
--rw-r--r--  2.0 unx     9455 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/static/description/icon.png
--rw-r--r--  2.0 unx    12741 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/static/description/index.html
--rw-r--r--  2.0 unx      112 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/tests/__init__.py
--rw-r--r--  2.0 unx     4910 b- defN 22-Aug-23 09:03 odoo/addons/account_invoice_margin_sale/tests/test_account_invoice_margin_sale.py
--rw-r--r--  2.0 unx     4125 b- defN 22-Aug-23 09:03 odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 22-Aug-23 09:03 odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 22-Aug-23 09:03 odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     2208 b- defN 22-Aug-23 09:03 odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2.dist-info/RECORD
-19 files, 41453 bytes uncompressed, 20789 bytes compressed:  49.8%
+Zip file size: 25595 bytes, number of entries: 20
+-rw-r--r--  2.0 unx     3765 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/README.rst
+-rw-r--r--  2.0 unx       86 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/__init__.py
+-rw-r--r--  2.0 unx      699 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/__manifest__.py
+-rw-r--r--  2.0 unx      810 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/i18n/account_invoice_margin_sale.pot
+-rw-r--r--  2.0 unx     1034 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/i18n/es.po
+-rw-r--r--  2.0 unx      114 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/models/__init__.py
+-rw-r--r--  2.0 unx     1051 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/models/account_invoice.py
+-rw-r--r--  2.0 unx      444 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/models/sale.py
+-rw-r--r--  2.0 unx      272 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/readme/CONTRIBUTORS.rst
+-rw-r--r--  2.0 unx      175 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/readme/DESCRIPTION.rst
+-rw-r--r--  2.0 unx       31 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/readme/INSTALL.rst
+-rw-r--r--  2.0 unx      144 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/readme/USAGE.rst
+-rw-r--r--  2.0 unx     9455 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/static/description/icon.png
+-rw-r--r--  2.0 unx    13328 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/static/description/index.html
+-rw-r--r--  2.0 unx      112 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/tests/__init__.py
+-rw-r--r--  2.0 unx     4992 b- defN 23-Jun-05 13:49 odoo/addons/account_invoice_margin_sale/tests/test_account_invoice_margin_sale.py
+-rw-r--r--  2.0 unx     4459 b- defN 23-Jun-05 13:49 odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Jun-05 13:49 odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 23-Jun-05 13:49 odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     2322 b- defN 23-Jun-05 13:49 odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3.dist-info/RECORD
+20 files, 43390 bytes uncompressed, 21549 bytes compressed:  50.3%
```

## zipnote {}

```diff
@@ -27,32 +27,35 @@
 
 Filename: odoo/addons/account_invoice_margin_sale/readme/DESCRIPTION.rst
 Comment: 
 
 Filename: odoo/addons/account_invoice_margin_sale/readme/INSTALL.rst
 Comment: 
 
+Filename: odoo/addons/account_invoice_margin_sale/readme/USAGE.rst
+Comment: 
+
 Filename: odoo/addons/account_invoice_margin_sale/static/description/icon.png
 Comment: 
 
 Filename: odoo/addons/account_invoice_margin_sale/static/description/index.html
 Comment: 
 
 Filename: odoo/addons/account_invoice_margin_sale/tests/__init__.py
 Comment: 
 
 Filename: odoo/addons/account_invoice_margin_sale/tests/test_account_invoice_margin_sale.py
 Comment: 
 
-Filename: odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2.dist-info/METADATA
+Filename: odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3.dist-info/METADATA
 Comment: 
 
-Filename: odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2.dist-info/WHEEL
+Filename: odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3.dist-info/WHEEL
 Comment: 
 
-Filename: odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2.dist-info/top_level.txt
+Filename: odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2.dist-info/RECORD
+Filename: odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/account_invoice_margin_sale/README.rst

```diff
@@ -10,44 +10,53 @@
 .. |badge1| image:: https://img.shields.io/badge/maturity-Production%2FStable-green.png
     :target: https://odoo-community.org/page/development-status
     :alt: Production/Stable
 .. |badge2| image:: https://img.shields.io/badge/licence-AGPL--3-blue.png
     :target: http://www.gnu.org/licenses/agpl-3.0-standalone.html
     :alt: License: AGPL-3
 .. |badge3| image:: https://img.shields.io/badge/github-OCA%2Fmargin--analysis-lightgray.png?logo=github
-    :target: https://github.com/OCA/margin-analysis/tree/15.0/account_invoice_margin_sale
+    :target: https://github.com/OCA/margin-analysis/tree/16.0/account_invoice_margin_sale
     :alt: OCA/margin-analysis
 .. |badge4| image:: https://img.shields.io/badge/weblate-Translate%20me-F47D42.png
-    :target: https://translation.odoo-community.org/projects/margin-analysis-15-0/margin-analysis-15-0-account_invoice_margin_sale
+    :target: https://translation.odoo-community.org/projects/margin-analysis-16-0/margin-analysis-16-0-account_invoice_margin_sale
     :alt: Translate me on Weblate
 .. |badge5| image:: https://img.shields.io/badge/runbot-Try%20me-875A7B.png
-    :target: https://runbot.odoo-community.org/runbot/132/15.0
+    :target: https://runbot.odoo-community.org/runbot/132/16.0
     :alt: Try me on Runbot
 
 |badge1| |badge2| |badge3| |badge4| |badge5| 
 
-This module allows transfer purchase price from sale order line to invoice.
+This module propagates purchase price from sale order line to invoice and discards the
+invoice lines coming from sale order lines with down-payment when computing the margin.
 
 **Table of contents**
 
 .. contents::
    :local:
 
 Installation
 ============
 
 This module is autoinstalable.
 
+Usage
+=====
+
+This module also needs a security group to show margins.
+
+#. To activate it go to user and active "Show Invoice Margin" in
+   security options.
+
 Bug Tracker
 ===========
 
 Bugs are tracked on `GitHub Issues <https://github.com/OCA/margin-analysis/issues>`_.
 In case of trouble, please check there if your issue has already been reported.
 If you spotted it first, help us smashing it by providing a detailed and welcomed
-`feedback <https://github.com/OCA/margin-analysis/issues/new?body=module:%20account_invoice_margin_sale%0Aversion:%2015.0%0A%0A**Steps%20to%20reproduce**%0A-%20...%0A%0A**Current%20behavior**%0A%0A**Expected%20behavior**>`_.
+`feedback <https://github.com/OCA/margin-analysis/issues/new?body=module:%20account_invoice_margin_sale%0Aversion:%2016.0%0A%0A**Steps%20to%20reproduce**%0A-%20...%0A%0A**Current%20behavior**%0A%0A**Expected%20behavior**>`_.
 
 Do not contact contributors directly about support or help with technical issues.
 
 Credits
 =======
 
 Authors
@@ -64,14 +73,18 @@
   * Carlos Dauden
   * Víctor Martínez
 
 * `Open Source Integrators <https://www.opensourceintegrators.com>`__:
 
   * Bhavesh Odedra
 
+* `Factor Libre <https://www.factorlibre.com>`__:
+
+  * Luis J. Salvatierra
+
 Maintainers
 ~~~~~~~~~~~
 
 This module is maintained by the OCA.
 
 .. image:: https://odoo-community.org/logo.png
    :alt: Odoo Community Association
@@ -88,10 +101,10 @@
     :target: https://github.com/carlosdauden
     :alt: carlosdauden
 
 Current `maintainers <https://odoo-community.org/page/maintainer-role>`__:
 
 |maintainer-sergio-teruel| |maintainer-carlosdauden| 
 
-This module is part of the `OCA/margin-analysis <https://github.com/OCA/margin-analysis/tree/15.0/account_invoice_margin_sale>`_ project on GitHub.
+This module is part of the `OCA/margin-analysis <https://github.com/OCA/margin-analysis/tree/16.0/account_invoice_margin_sale>`_ project on GitHub.
 
 You are welcome to contribute. To learn how please visit https://odoo-community.org/page/Contribute.
```

## odoo/addons/account_invoice_margin_sale/__manifest__.py

```diff
@@ -1,15 +1,15 @@
 # Copyright 2017-2018 Tecnativa - Sergio Teruel
 # Copyright 2019 Tecnativa - Carlos Dauden
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/lgpl).
 
 {
     "name": "Account Invoice Margin Sale",
     "summary": "Set margin in invoices from sale orders",
-    "version": "15.0.1.0.0",
+    "version": "16.0.1.0.0",
     "development_status": "Production/Stable",
     "maintainers": ["sergio-teruel", "carlosdauden"],
     "category": "Account",
     "website": "https://github.com/OCA/margin-analysis",
     "author": "Tecnativa, " "Odoo Community Association (OCA)",
     "license": "AGPL-3",
     "application": False,
```

## odoo/addons/account_invoice_margin_sale/i18n/account_invoice_margin_sale.pot

```diff
@@ -1,14 +1,14 @@
 # Translation of Odoo Server.
 # This file contains the translation of the following modules:
 # 	* account_invoice_margin_sale
 #
 msgid ""
 msgstr ""
-"Project-Id-Version: Odoo Server 15.0\n"
+"Project-Id-Version: Odoo Server 16.0\n"
 "Report-Msgid-Bugs-To: \n"
 "Last-Translator: \n"
 "Language-Team: \n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: \n"
 "Plural-Forms: \n"
```

## odoo/addons/account_invoice_margin_sale/models/account_invoice.py

```diff
@@ -4,24 +4,30 @@
 from odoo import api, models
 
 
 class AccountMove(models.Model):
     _inherit = "account.move"
 
     def _get_margin_applicable_lines(self):
-        lines = super()._get_margin_applicable_lines()
-        return lines.filtered(lambda x: not x.sale_line_ids.is_downpayment)
+        invoice_lines = super()._get_margin_applicable_lines()
+        return invoice_lines.filtered(
+            lambda x: not any(x.sale_line_ids.mapped("is_downpayment"))
+        )
 
 
 class AccountMoveLine(models.Model):
     _inherit = "account.move.line"
 
     # pylint: disable=W8110
     @api.depends("purchase_price", "price_subtotal")
     def _compute_margin(self):
-        for line in self:
-            if any(line.sale_line_ids.mapped("is_downpayment")):
-                line.update(
-                    {"margin": 0.0, "margin_signed": 0.0, "margin_percent": 0.0}
-                )
-            else:
-                super(AccountMoveLine, line)._compute_margin()
+        invoice_lines_with_downpayment = self.filtered(
+            lambda x: any(x.sale_line_ids.mapped("is_downpayment"))
+        )
+        invoice_lines_with_downpayment.update(
+            {
+                "margin": 0.0,
+                "margin_signed": 0.0,
+                "margin_percent": 0.0,
+            }
+        )
+        super(AccountMoveLine, self - invoice_lines_with_downpayment)._compute_margin()
```

## odoo/addons/account_invoice_margin_sale/readme/CONTRIBUTORS.rst

```diff
@@ -3,7 +3,11 @@
   * Sergio Teruel
   * Carlos Dauden
   * Víctor Martínez
 
 * `Open Source Integrators <https://www.opensourceintegrators.com>`__:
 
   * Bhavesh Odedra
+
+* `Factor Libre <https://www.factorlibre.com>`__:
+
+  * Luis J. Salvatierra
```

## odoo/addons/account_invoice_margin_sale/readme/DESCRIPTION.rst

```diff
@@ -1 +1,2 @@
-This module allows transfer purchase price from sale order line to invoice.
+This module propagates purchase price from sale order line to invoice and discards the
+invoice lines coming from sale order lines with down-payment when computing the margin.
```

## odoo/addons/account_invoice_margin_sale/static/description/index.html

### odoo/addons/account_invoice_margin_sale/static/description/index.html

```diff
@@ -367,88 +367,102 @@
       <p>
         <a class="reference external" href="https://odoo-community.org/page/development-status">
           <img alt="Production/Stable" src="https://img.shields.io/badge/maturity-Production%2FStable-green.png"/>
         </a>
         <a class="reference external" href="http://www.gnu.org/licenses/agpl-3.0-standalone.html">
           <img alt="License: AGPL-3" src="https://img.shields.io/badge/licence-AGPL--3-blue.png"/>
         </a>
-        <a class="reference external" href="https://github.com/OCA/margin-analysis/tree/15.0/account_invoice_margin_sale">
+        <a class="reference external" href="https://github.com/OCA/margin-analysis/tree/16.0/account_invoice_margin_sale">
           <img alt="OCA/margin-analysis" src="https://img.shields.io/badge/github-OCA%2Fmargin--analysis-lightgray.png?logo=github"/>
         </a>
-        <a class="reference external" href="https://translation.odoo-community.org/projects/margin-analysis-15-0/margin-analysis-15-0-account_invoice_margin_sale">
+        <a class="reference external" href="https://translation.odoo-community.org/projects/margin-analysis-16-0/margin-analysis-16-0-account_invoice_margin_sale">
           <img alt="Translate me on Weblate" src="https://img.shields.io/badge/weblate-Translate%20me-F47D42.png"/>
         </a>
-        <a class="reference external" href="https://runbot.odoo-community.org/runbot/132/15.0">
+        <a class="reference external" href="https://runbot.odoo-community.org/runbot/132/16.0">
           <img alt="Try me on Runbot" src="https://img.shields.io/badge/runbot-Try%20me-875A7B.png"/>
         </a>
       </p>
-      <p>This module allows transfer purchase price from sale order line to invoice.</p>
+      <p>This module propagates purchase price from sale order line to invoice and discards the
+invoice lines coming from sale order lines with down-payment when computing the margin.</p>
       <p>
         <strong>Table of contents</strong>
       </p>
       <div class="contents local topic" id="contents">
         <ul class="simple">
           <li>
             <a class="reference internal" href="#installation" id="id1">Installation</a>
           </li>
           <li>
-            <a class="reference internal" href="#bug-tracker" id="id2">Bug Tracker</a>
+            <a class="reference internal" href="#usage" id="id2">Usage</a>
           </li>
           <li>
-            <a class="reference internal" href="#credits" id="id3">Credits</a>
+            <a class="reference internal" href="#bug-tracker" id="id3">Bug Tracker</a>
+          </li>
+          <li>
+            <a class="reference internal" href="#credits" id="id4">Credits</a>
             <ul>
               <li>
-                <a class="reference internal" href="#authors" id="id4">Authors</a>
+                <a class="reference internal" href="#authors" id="id5">Authors</a>
               </li>
               <li>
-                <a class="reference internal" href="#contributors" id="id5">Contributors</a>
+                <a class="reference internal" href="#contributors" id="id6">Contributors</a>
               </li>
               <li>
-                <a class="reference internal" href="#maintainers" id="id6">Maintainers</a>
+                <a class="reference internal" href="#maintainers" id="id7">Maintainers</a>
               </li>
             </ul>
           </li>
         </ul>
       </div>
       <div class="section" id="installation">
         <h1>
           <a class="toc-backref" href="#id1">Installation</a>
         </h1>
         <p>This module is autoinstalable.</p>
       </div>
+      <div class="section" id="usage">
+        <h1>
+          <a class="toc-backref" href="#id2">Usage</a>
+        </h1>
+        <p>This module also needs a security group to show margins.</p>
+        <ol class="arabic simple">
+          <li>To activate it go to user and active “Show Invoice Margin” in
+security options.</li>
+        </ol>
+      </div>
       <div class="section" id="bug-tracker">
         <h1>
-          <a class="toc-backref" href="#id2">Bug Tracker</a>
+          <a class="toc-backref" href="#id3">Bug Tracker</a>
         </h1>
         <p>
           Bugs are tracked on
           <a class="reference external" href="https://github.com/OCA/margin-analysis/issues">GitHub Issues</a>
           .
 In case of trouble, please check there if your issue has already been reported.
 If you spotted it first, help us smashing it by providing a detailed and welcomed
-          <a class="reference external" href="https://github.com/OCA/margin-analysis/issues/new?body=module:%20account_invoice_margin_sale%0Aversion:%2015.0%0A%0A**Steps%20to%20reproduce**%0A-%20...%0A%0A**Current%20behavior**%0A%0A**Expected%20behavior**">feedback</a>
+          <a class="reference external" href="https://github.com/OCA/margin-analysis/issues/new?body=module:%20account_invoice_margin_sale%0Aversion:%2016.0%0A%0A**Steps%20to%20reproduce**%0A-%20...%0A%0A**Current%20behavior**%0A%0A**Expected%20behavior**">feedback</a>
           .
         </p>
         <p>Do not contact contributors directly about support or help with technical issues.</p>
       </div>
       <div class="section" id="credits">
         <h1>
-          <a class="toc-backref" href="#id3">Credits</a>
+          <a class="toc-backref" href="#id4">Credits</a>
         </h1>
         <div class="section" id="authors">
           <h2>
-            <a class="toc-backref" href="#id4">Authors</a>
+            <a class="toc-backref" href="#id5">Authors</a>
           </h2>
           <ul class="simple">
             <li>Tecnativa</li>
           </ul>
         </div>
         <div class="section" id="contributors">
           <h2>
-            <a class="toc-backref" href="#id5">Contributors</a>
+            <a class="toc-backref" href="#id6">Contributors</a>
           </h2>
           <ul class="simple">
             <li>
               <a class="reference external" href="https://www.tecnativa.com">Tecnativa</a>
               :
               <ul>
                 <li>Sergio Teruel</li>
@@ -459,19 +473,26 @@
             <li>
               <a class="reference external" href="https://www.opensourceintegrators.com">Open Source Integrators</a>
               :
               <ul>
                 <li>Bhavesh Odedra</li>
               </ul>
             </li>
+            <li>
+              <a class="reference external" href="https://www.factorlibre.com">Factor Libre</a>
+              :
+              <ul>
+                <li>Luis J. Salvatierra</li>
+              </ul>
+            </li>
           </ul>
         </div>
         <div class="section" id="maintainers">
           <h2>
-            <a class="toc-backref" href="#id6">Maintainers</a>
+            <a class="toc-backref" href="#id7">Maintainers</a>
           </h2>
           <p>This module is maintained by the OCA.</p>
           <a class="reference external image-reference" href="https://odoo-community.org">
             <img alt="Odoo Community Association" src="https://odoo-community.org/logo.png"/>
           </a>
           <p>OCA, or the Odoo Community Association, is a nonprofit organization whose
 mission is to support the collaborative development of Odoo features and
@@ -487,15 +508,15 @@
             </a>
             <a class="reference external" href="https://github.com/carlosdauden">
               <img alt="carlosdauden" src="https://github.com/carlosdauden.png?size=40px"/>
             </a>
           </p>
           <p>
             This module is part of the
-            <a class="reference external" href="https://github.com/OCA/margin-analysis/tree/15.0/account_invoice_margin_sale">OCA/margin-analysis</a>
+            <a class="reference external" href="https://github.com/OCA/margin-analysis/tree/16.0/account_invoice_margin_sale">OCA/margin-analysis</a>
             project on GitHub.
           </p>
           <p>
             You are welcome to contribute. To learn how please visit
             <a class="reference external" href="https://odoo-community.org/page/Contribute">https://odoo-community.org/page/Contribute</a>
             .
           </p>
```

## odoo/addons/account_invoice_margin_sale/tests/test_account_invoice_margin_sale.py

```diff
@@ -5,29 +5,32 @@
 from odoo.tests.common import TransactionCase
 
 
 class TestAccountInvoiceMargin(TransactionCase):
     @classmethod
     def setUpClass(cls):
         super().setUpClass()
+        cls.env = cls.env(
+            context=dict(
+                cls.env.context,
+                mail_create_nolog=True,
+                mail_create_nosubscribe=True,
+                mail_notrack=True,
+                no_reset_password=True,
+                tracking_disable=True,
+            )
+        )
         cls.journal = cls.env["account.journal"].create(
             {"name": "Test journal", "type": "sale", "code": "TEST_J"}
         )
-        cls.account_type = cls.env["account.account.type"].create(
-            {
-                "name": "Test account type",
-                "type": "receivable",
-                "internal_group": "income",
-            }
-        )
         cls.account = cls.env["account.account"].create(
             {
                 "name": "Test account",
-                "code": "TEST_A",
-                "user_type_id": cls.account_type.id,
+                "code": "TESTACCRECV",
+                "account_type": "asset_receivable",
                 "reconcile": True,
             }
         )
         cls.partner = cls.env["res.partner"].create(
             {"name": "Test partner", "customer_rank": 1, "is_company": True}
         )
         cls.partner.property_account_receivable_id = cls.account
```

## Comparing `odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2.dist-info/METADATA` & `odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3.dist-info/METADATA`

 * *Files 11% similar despite different names*

```diff
@@ -1,24 +1,24 @@
 Metadata-Version: 2.1
 Name: odoo-addon-account-invoice-margin-sale
-Version: 15.0.1.0.0.2
+Version: 16.0.1.0.0.3
 Summary: Set margin in invoices from sale orders
 Home-page: https://github.com/OCA/margin-analysis
 Author: Tecnativa, Odoo Community Association (OCA)
 Author-email: support@odoo-community.org
 License: AGPL-3
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
 Classifier: Framework :: Odoo
-Classifier: Framework :: Odoo :: 15.0
+Classifier: Framework :: Odoo :: 16.0
 Classifier: License :: OSI Approved :: GNU Affero General Public License v3
 Classifier: Development Status :: 5 - Production/Stable
-Requires-Python: >=3.8
-Requires-Dist: odoo-addon-account-invoice-margin (<15.1dev,>=15.0dev)
-Requires-Dist: odoo (<15.1dev,>=15.0a)
+Requires-Python: >=3.10
+Requires-Dist: odoo-addon-account-invoice-margin (<16.1dev,>=16.0dev)
+Requires-Dist: odoo (<16.1dev,>=16.0a)
 
 ===========================
 Account Invoice Margin Sale
 ===========================
 
 .. !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !! This file is generated by oca-gen-addon-readme !!
@@ -28,44 +28,53 @@
 .. |badge1| image:: https://img.shields.io/badge/maturity-Production%2FStable-green.png
     :target: https://odoo-community.org/page/development-status
     :alt: Production/Stable
 .. |badge2| image:: https://img.shields.io/badge/licence-AGPL--3-blue.png
     :target: http://www.gnu.org/licenses/agpl-3.0-standalone.html
     :alt: License: AGPL-3
 .. |badge3| image:: https://img.shields.io/badge/github-OCA%2Fmargin--analysis-lightgray.png?logo=github
-    :target: https://github.com/OCA/margin-analysis/tree/15.0/account_invoice_margin_sale
+    :target: https://github.com/OCA/margin-analysis/tree/16.0/account_invoice_margin_sale
     :alt: OCA/margin-analysis
 .. |badge4| image:: https://img.shields.io/badge/weblate-Translate%20me-F47D42.png
-    :target: https://translation.odoo-community.org/projects/margin-analysis-15-0/margin-analysis-15-0-account_invoice_margin_sale
+    :target: https://translation.odoo-community.org/projects/margin-analysis-16-0/margin-analysis-16-0-account_invoice_margin_sale
     :alt: Translate me on Weblate
 .. |badge5| image:: https://img.shields.io/badge/runbot-Try%20me-875A7B.png
-    :target: https://runbot.odoo-community.org/runbot/132/15.0
+    :target: https://runbot.odoo-community.org/runbot/132/16.0
     :alt: Try me on Runbot
 
 |badge1| |badge2| |badge3| |badge4| |badge5| 
 
-This module allows transfer purchase price from sale order line to invoice.
+This module propagates purchase price from sale order line to invoice and discards the
+invoice lines coming from sale order lines with down-payment when computing the margin.
 
 **Table of contents**
 
 .. contents::
    :local:
 
 Installation
 ============
 
 This module is autoinstalable.
 
+Usage
+=====
+
+This module also needs a security group to show margins.
+
+#. To activate it go to user and active "Show Invoice Margin" in
+   security options.
+
 Bug Tracker
 ===========
 
 Bugs are tracked on `GitHub Issues <https://github.com/OCA/margin-analysis/issues>`_.
 In case of trouble, please check there if your issue has already been reported.
 If you spotted it first, help us smashing it by providing a detailed and welcomed
-`feedback <https://github.com/OCA/margin-analysis/issues/new?body=module:%20account_invoice_margin_sale%0Aversion:%2015.0%0A%0A**Steps%20to%20reproduce**%0A-%20...%0A%0A**Current%20behavior**%0A%0A**Expected%20behavior**>`_.
+`feedback <https://github.com/OCA/margin-analysis/issues/new?body=module:%20account_invoice_margin_sale%0Aversion:%2016.0%0A%0A**Steps%20to%20reproduce**%0A-%20...%0A%0A**Current%20behavior**%0A%0A**Expected%20behavior**>`_.
 
 Do not contact contributors directly about support or help with technical issues.
 
 Credits
 =======
 
 Authors
@@ -82,14 +91,18 @@
   * Carlos Dauden
   * Víctor Martínez
 
 * `Open Source Integrators <https://www.opensourceintegrators.com>`__:
 
   * Bhavesh Odedra
 
+* `Factor Libre <https://www.factorlibre.com>`__:
+
+  * Luis J. Salvatierra
+
 Maintainers
 ~~~~~~~~~~~
 
 This module is maintained by the OCA.
 
 .. image:: https://odoo-community.org/logo.png
    :alt: Odoo Community Association
@@ -106,12 +119,12 @@
     :target: https://github.com/carlosdauden
     :alt: carlosdauden
 
 Current `maintainers <https://odoo-community.org/page/maintainer-role>`__:
 
 |maintainer-sergio-teruel| |maintainer-carlosdauden| 
 
-This module is part of the `OCA/margin-analysis <https://github.com/OCA/margin-analysis/tree/15.0/account_invoice_margin_sale>`_ project on GitHub.
+This module is part of the `OCA/margin-analysis <https://github.com/OCA/margin-analysis/tree/16.0/account_invoice_margin_sale>`_ project on GitHub.
 
 You are welcome to contribute. To learn how please visit https://odoo-community.org/page/Contribute.
```

## Comparing `odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2.dist-info/RECORD` & `odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3.dist-info/RECORD`

 * *Files 11% similar despite different names*

```diff
@@ -1,19 +1,20 @@
-odoo/addons/account_invoice_margin_sale/README.rst,sha256=mezk7YcNbBBL_9uPpKwDiSVtQLV_th_2C2qehZK5LJs,3432
+odoo/addons/account_invoice_margin_sale/README.rst,sha256=lS3RXhOviZuiPC_G5u4fAAmH3c9qRM0Sl5Dmn0ljMMk,3765
 odoo/addons/account_invoice_margin_sale/__init__.py,sha256=ZGjmXT9q1Wc3A9Eb3pRZjwDcSFijPJcJLFSMyZdyxyU,86
-odoo/addons/account_invoice_margin_sale/__manifest__.py,sha256=uvmMj9NtFENSACmCGRIdlpy7MYv-zcNFZ7gbT4p7LAk,699
-odoo/addons/account_invoice_margin_sale/i18n/account_invoice_margin_sale.pot,sha256=7YwqhHYBxTlpALcEVJSlSNUYUs5Ybn3Z7uDptdYMkb8,810
+odoo/addons/account_invoice_margin_sale/__manifest__.py,sha256=x-ArndGSdKdVKFKtWOT2TKJuS48pc3veZhTg9UWurPc,699
+odoo/addons/account_invoice_margin_sale/i18n/account_invoice_margin_sale.pot,sha256=LbNIrCXWTkQ0p8HHdTDxPYmTTRTFzUC8XEE6KBScLkM,810
 odoo/addons/account_invoice_margin_sale/i18n/es.po,sha256=Pg0YRtx4fWjBIuFk6mTry2ZbYdhXmoVazd6E8kPri0Q,1034
 odoo/addons/account_invoice_margin_sale/models/__init__.py,sha256=ecHw4HUxBRCJtj98oqKcMkhuK5ERcZLsxNX5F68gnlM,114
-odoo/addons/account_invoice_margin_sale/models/account_invoice.py,sha256=16iB6X8hLNlPpp3mftYhiy_rRhD7YqebtoCuODtMaZY,883
+odoo/addons/account_invoice_margin_sale/models/account_invoice.py,sha256=P9ohLLNyL5bbh3vP8SOrER4M0cq_3HT8umxrpUoDznA,1051
 odoo/addons/account_invoice_margin_sale/models/sale.py,sha256=UbgQBejuM60cWx1os5l8siTmuW8-euI5YJyhh33wxxw,444
-odoo/addons/account_invoice_margin_sale/readme/CONTRIBUTORS.rst,sha256=HiVFYOUCtnFmlgh53j0bCnhUYD8PHDf30V8A6vXtuVo,196
-odoo/addons/account_invoice_margin_sale/readme/DESCRIPTION.rst,sha256=vK_7jrJG2nGiGblJ7-ghjVjRMnzR9PooMRQra_QTg6s,76
+odoo/addons/account_invoice_margin_sale/readme/CONTRIBUTORS.rst,sha256=YJ6NGcJpyZVDrNz7sAR1dt0ADPpUNsfWmqZZ812-Ln8,272
+odoo/addons/account_invoice_margin_sale/readme/DESCRIPTION.rst,sha256=SD8v7nE_3_LtLClwuqG4N35Xa2fxGabaMGjr9aa4KOc,175
 odoo/addons/account_invoice_margin_sale/readme/INSTALL.rst,sha256=W0OpDReZcT7zYP6-2Ur2ZLwMnl1mGJ-u2mgaEAfnQhw,31
+odoo/addons/account_invoice_margin_sale/readme/USAGE.rst,sha256=6k4XfIWPvynB-mXYPO_YXA-iBkO5o37gBP4L0Rv8UHU,144
 odoo/addons/account_invoice_margin_sale/static/description/icon.png,sha256=6xBPJauaFOF0KDHfHgQopSc28kKvxMaeoQFQWZtfZDo,9455
-odoo/addons/account_invoice_margin_sale/static/description/index.html,sha256=mshAxRCh1XGtPEE84JKl-mYo52F1Rm7h62BWp03euZY,12741
+odoo/addons/account_invoice_margin_sale/static/description/index.html,sha256=f-6Ms13KV4NdGORu-dcRjZQnQIk0GggQp5-3agZ5gQ0,13328
 odoo/addons/account_invoice_margin_sale/tests/__init__.py,sha256=TjeFV8qjzLUamZ-_2sxQdmwTtJrp-FWkNAu1E_xQ26Q,112
-odoo/addons/account_invoice_margin_sale/tests/test_account_invoice_margin_sale.py,sha256=wPpaxNbF1GP_z8JSsBBJDjAj8EHqbDq_T0rFA33K2Hw,4910
-odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2.dist-info/METADATA,sha256=Fob8nT430eNzFK9JHgZonIqaL0sksegiMMn90w_axaU,4125
-odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2.dist-info/WHEEL,sha256=G16H4A3IeoQmnOrYV4ueZGKSjhipXx8zc8nu9FGlvMA,92
-odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo_addon_account_invoice_margin_sale-15.0.1.0.0.2.dist-info/RECORD,,
+odoo/addons/account_invoice_margin_sale/tests/test_account_invoice_margin_sale.py,sha256=iHglqq8jGPx1pP0mMPI07j-pEc_w8urVxHm3oobjkgI,4992
+odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3.dist-info/METADATA,sha256=_IlUHVd3tvvcOf020MOJSCvl_GqXlApLxjpR-Yw4Tn0,4459
+odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3.dist-info/WHEEL,sha256=2wepM1nk4DS4eFpYrW1TTqPcoGNfHhhO_i5m4cOimbo,92
+odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo_addon_account_invoice_margin_sale-16.0.1.0.0.3.dist-info/RECORD,,
```

