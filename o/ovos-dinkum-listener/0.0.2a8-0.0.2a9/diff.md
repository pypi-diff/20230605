# Comparing `tmp/ovos_dinkum_listener-0.0.2a8-py3-none-any.whl.zip` & `tmp/ovos_dinkum_listener-0.0.2a9-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,16 +1,16 @@
-Zip file size: 21195 bytes, number of entries: 14
--rw-r--r--  2.0 unx      578 b- defN 23-Apr-26 21:59 ovos_dinkum_listener/__init__.py
--rw-r--r--  2.0 unx    26580 b- defN 23-Apr-26 21:59 ovos_dinkum_listener/__main__.py
--rw-r--r--  2.0 unx     2784 b- defN 23-Apr-26 21:59 ovos_dinkum_listener/plugins.py
--rw-r--r--  2.0 unx     4739 b- defN 23-Apr-26 21:59 ovos_dinkum_listener/transformers.py
--rw-r--r--  2.0 unx      114 b- defN 23-Apr-26 21:59 ovos_dinkum_listener/version.py
--rw-r--r--  2.0 unx      752 b- defN 23-Apr-26 21:59 ovos_dinkum_listener/voice_loop/__init__.py
--rw-r--r--  2.0 unx     8686 b- defN 23-Apr-26 21:59 ovos_dinkum_listener/voice_loop/hotwords.py
--rw-r--r--  2.0 unx     4630 b- defN 23-Apr-26 21:59 ovos_dinkum_listener/voice_loop/microphone.py
--rw-r--r--  2.0 unx    18031 b- defN 23-Apr-26 21:59 ovos_dinkum_listener/voice_loop/voice_loop.py
--rw-r--r--  2.0 unx      636 b- defN 23-Apr-26 21:59 ovos_dinkum_listener-0.0.2a8.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Apr-26 21:59 ovos_dinkum_listener-0.0.2a8.dist-info/WHEEL
--rw-r--r--  2.0 unx       77 b- defN 23-Apr-26 21:59 ovos_dinkum_listener-0.0.2a8.dist-info/entry_points.txt
--rw-r--r--  2.0 unx       21 b- defN 23-Apr-26 21:59 ovos_dinkum_listener-0.0.2a8.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     1317 b- defN 23-Apr-26 21:59 ovos_dinkum_listener-0.0.2a8.dist-info/RECORD
-14 files, 69037 bytes uncompressed, 18947 bytes compressed:  72.6%
+Zip file size: 21584 bytes, number of entries: 14
+-rw-r--r--  2.0 unx      578 b- defN 23-May-04 16:19 ovos_dinkum_listener/__init__.py
+-rw-r--r--  2.0 unx    26580 b- defN 23-May-04 16:19 ovos_dinkum_listener/__main__.py
+-rw-r--r--  2.0 unx     2759 b- defN 23-May-04 16:19 ovos_dinkum_listener/plugins.py
+-rw-r--r--  2.0 unx     4807 b- defN 23-May-04 16:19 ovos_dinkum_listener/transformers.py
+-rw-r--r--  2.0 unx      114 b- defN 23-May-04 16:19 ovos_dinkum_listener/version.py
+-rw-r--r--  2.0 unx      752 b- defN 23-May-04 16:19 ovos_dinkum_listener/voice_loop/__init__.py
+-rw-r--r--  2.0 unx     8686 b- defN 23-May-04 16:19 ovos_dinkum_listener/voice_loop/hotwords.py
+-rw-r--r--  2.0 unx     4630 b- defN 23-May-04 16:19 ovos_dinkum_listener/voice_loop/microphone.py
+-rw-r--r--  2.0 unx    19265 b- defN 23-May-04 16:19 ovos_dinkum_listener/voice_loop/voice_loop.py
+-rw-r--r--  2.0 unx      636 b- defN 23-May-04 16:19 ovos_dinkum_listener-0.0.2a9.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-May-04 16:19 ovos_dinkum_listener-0.0.2a9.dist-info/WHEEL
+-rw-r--r--  2.0 unx       77 b- defN 23-May-04 16:19 ovos_dinkum_listener-0.0.2a9.dist-info/entry_points.txt
+-rw-r--r--  2.0 unx       21 b- defN 23-May-04 16:19 ovos_dinkum_listener-0.0.2a9.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     1317 b- defN 23-May-04 16:19 ovos_dinkum_listener-0.0.2a9.dist-info/RECORD
+14 files, 70314 bytes uncompressed, 19336 bytes compressed:  72.5%
```

## zipnote {}

```diff
@@ -21,23 +21,23 @@
 
 Filename: ovos_dinkum_listener/voice_loop/microphone.py
 Comment: 
 
 Filename: ovos_dinkum_listener/voice_loop/voice_loop.py
 Comment: 
 
-Filename: ovos_dinkum_listener-0.0.2a8.dist-info/METADATA
+Filename: ovos_dinkum_listener-0.0.2a9.dist-info/METADATA
 Comment: 
 
-Filename: ovos_dinkum_listener-0.0.2a8.dist-info/WHEEL
+Filename: ovos_dinkum_listener-0.0.2a9.dist-info/WHEEL
 Comment: 
 
-Filename: ovos_dinkum_listener-0.0.2a8.dist-info/entry_points.txt
+Filename: ovos_dinkum_listener-0.0.2a9.dist-info/entry_points.txt
 Comment: 
 
-Filename: ovos_dinkum_listener-0.0.2a8.dist-info/top_level.txt
+Filename: ovos_dinkum_listener-0.0.2a9.dist-info/top_level.txt
 Comment: 
 
-Filename: ovos_dinkum_listener-0.0.2a8.dist-info/RECORD
+Filename: ovos_dinkum_listener-0.0.2a9.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## ovos_dinkum_listener/plugins.py

```diff
@@ -9,28 +9,27 @@
 from speech_recognition import AudioData
 
 
 class FakeStreamThread(StreamThread):
 
     def __init__(self, queue, language, engine, sample_rate, sample_width):
         super().__init__(queue, language)
-        self.lang = language
         self.buffer = ReadWriteStream()
         self.engine = engine
         self.sample_rate = sample_rate
         self.sample_width = sample_width
 
     def finalize(self):
         """ return final transcription """
         try:
             # plugins expect AudioData objects
             audio = AudioData(self.buffer.read(),
                               sample_rate=self.sample_rate,
                               sample_width=self.sample_width)
-            transcript = self.engine.execute(audio, self.lang)
+            transcript = self.engine.execute(audio, self.language)
 
             self.buffer.clear()
             return transcript
         except Exception:
             LOG.exception(f"Error in STT plugin: {self.engine.__class__.__name__}")
         return None
```

## ovos_dinkum_listener/transformers.py

```diff
@@ -31,15 +31,15 @@
 from ovos_utils.log import LOG
 
 
 class AudioTransformersService:
 
     def __init__(self, bus, config=None):
         self.config_core = config or {}
-        self.loaded_modules = {}
+        self.loaded_plugins = {}
         self.has_loaded = False
         self.bus = bus
         # to activate a plugin, just add an entry to mycroft.conf for it
         self.config = self.config_core.get("audio_transformers") or {
           #  "ovos-audio-classifier-gender": {}
         }
         self.load_plugins()
@@ -47,62 +47,63 @@
     def load_plugins(self):
         for plug_name, plug in find_audio_transformer_plugins().items():
             if plug_name in self.config:
                 # if disabled skip it
                 if not self.config[plug_name].get("active", True):
                     continue
                 try:
-                    self.loaded_modules[plug_name] = plug()
+                    self.loaded_plugins[plug_name] = plug()
                     LOG.info(f"loaded audio transformer plugin: {plug_name}")
                 except Exception as e:
-                    LOG.exception(f"Failed to load audio transfomer plugin: {plug_name}")
+                    LOG.exception(f"Failed to load audio transformer plugin: {plug_name}")
 
     @property
-    def modules(self):
+    def plugins(self):
         """
         Return loaded transformers in priority order, such that modules with a
         higher `priority` rank are called first and changes from lower ranked
         transformers are applied last.
 
         A plugin of `priority` 1 will override any existing context keys and
         will be the last to modify `audio_data`
         """
-        return sorted(self.loaded_modules.values(),
+        return sorted(self.loaded_plugins.values(),
                       key=lambda k: k.priority, reverse=True)
 
     def shutdown(self):
-        for module in self.modules:
+        for module in self.plugins:
             try:
                 module.shutdown()
             except:
                 pass
 
     def feed_audio(self, chunk):
         #   print("...feeding audio", len(chunk))
-        for module in self.modules:
+        for module in self.plugins:
             module.feed_audio_chunk(chunk)
 
     def feed_hotword(self, chunk):
         #  print("....feeding ww", len(chunk))
-        for module in self.modules:
+        for module in self.plugins:
             module.feed_hotword_chunk(chunk)
 
     def feed_speech(self, chunk):
         try:
-            for module in self.modules:
+            for module in self.plugins:
                 module.feed_speech_chunk(chunk)
         except Exception as e:
             LOG.exception(e)
 
     def transform(self, chunk):
         context = {'client_name': 'ovos_dinkum_listener',
                    'source': 'audio',  # default native audio source
                    'destination': ["skills"]}
-        for module in self.modules:
+        for module in self.plugins:
             try:
+                LOG.debug(f"checking audio transformer: {module}")
                 chunk = module.feed_speech_utterance(chunk)
                 chunk, data = module.transform(chunk)
                 LOG.debug(f"{module.name}: {data}")
                 context = merge_dict(context, data)
             except Exception as e:
                 LOG.exception(e)
         return chunk, context
```

## ovos_dinkum_listener/version.py

```diff
@@ -1,6 +1,6 @@
 # START_VERSION_BLOCK
 VERSION_MAJOR = 0
 VERSION_MINOR = 0
 VERSION_BUILD = 2
-VERSION_ALPHA = 8
+VERSION_ALPHA = 9
 # END_VERSION_BLOCK
```

## ovos_dinkum_listener/voice_loop/voice_loop.py

```diff
@@ -428,18 +428,40 @@
                     # End of voice command detected
                     self.state = ListeningState.AFTER_COMMAND
                     break
             else:
                 # Reset
                 self.silence_seconds_left = self.silence_seconds
 
-    def _after_cmd(self, chunk):
-        # Command has ended, call transformers pipeline before STT
-        chunk, stt_context = self.transformers.transform(chunk)
-        LOG.debug(f"transformers metadata: {stt_context}")
+    def _validate_lang(self, lang):
+        """ ensure lang classification from speech is one of the valid langs
+        if not then drop classification, as there are no speakers of that language around this device
+        """
+        cfg = Configuration()
+        default_lang = cfg.get("lang", "en-us")
+        valid_langs = set([default_lang] + cfg.get("secondary_langs'", []))
+
+        if lang in valid_langs:
+            if lang != default_lang:
+                LOG.info(f"replaced {default_lang} with {lang}")
+            return v
+        else:
+            LOG.warning(f"ignoring classification: {lang} is not in enabled languages: {valid_langs}")
+
+        return default_lang
+
+    def _get_tx(self, stt_context):
+        # handle lang detection from speech
+        if "stt_lang" in stt_context:
+            lang = self._validate_lang(stt_context["stt_lang"])
+            # note: self.stt.stream is recreated every listen start
+            # this is safe to do, and makes lang be passed to self.execute
+            self.stt.stream.language = lang
+            if self.fallback_stt:
+                self.fallback_stt.stream.language = lang
 
         # get text and trigger callback
         try:
             text = self.stt.stream_stop() or ""
         except:
             LOG.exception("STT failed")
             text = ""
@@ -449,14 +471,23 @@
             text = self.fallback_stt.stream_stop() or ""
 
         # TODO - some plugins return list of transcripts some just text
         # standardize support for this
         if isinstance(text, list):
             text = text[0]
         stt_context["transcription"] = text
+        return text, stt_context
+
+    def _after_cmd(self, chunk):
+        # Command has ended, call transformers pipeline before STT
+        chunk, stt_context = self.transformers.transform(chunk)
+        LOG.debug(f"transformers metadata: {stt_context}")
+
+        text, stt_context = self._get_tx(stt_context)
+
 
         # Voice command has finished recording
         if self.stt_audio_callback is not None:
             metadata = self.stt_audio_callback(self.stt_audio_bytes, stt_context)
 
         self.stt_audio_bytes = bytes()
```

## Comparing `ovos_dinkum_listener-0.0.2a8.dist-info/METADATA` & `ovos_dinkum_listener-0.0.2a9.dist-info/METADATA`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: ovos-dinkum-listener
-Version: 0.0.2a8
+Version: 0.0.2a9
 Summary: ovos-core listener daemon client
 Home-page: https://github.com/OpenVoiceOS/ovos-dinkum-listener
 Author: UNKNOWN
 Author-email: UNKNOWN
 License: Apache-2.0
 Platform: UNKNOWN
 Classifier: Development Status :: 4 - Beta
```

